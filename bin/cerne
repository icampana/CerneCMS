#!/usr/bin/env php
<?php

// CLI Entry Point for CerneCMS

require __DIR__ . '/../vendor/autoload.php';

// Minimal Flight setup for database access
$config = require __DIR__ . '/../app/config/config.php';

use app\core\Database;
use app\commands\UserCreateCommand;
use app\commands\CacheClearCommand;

// Register DB connection manually since we aren't starting Flight
Flight::register('db', 'PDO', ["sqlite:{$config['database_path']}"], function ($db) {
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $db->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
    $db->exec('PRAGMA foreign_keys = ON;');
});

// Init DB to ensure tables exist
Database::init();

$args = array_slice($argv, 1);
$commandName = $args[0] ?? 'help';
$commandArgs = array_slice($args, 1);

// Register Commands
$commands = [
    'user:create' => new UserCreateCommand(),
    'cache:clear' => new CacheClearCommand(),
    'system:check' => new \app\commands\SystemCheckCommand(),
    'demo:reset' => new \app\commands\DemoResetCommand(),
];

echo "CerneCMS CLI Tool\n";
echo "-----------------\n";

// Special command: serve (start PHP built-in server)
if ($commandName === 'serve') {
    $port = $commandArgs[0] ?? '8080';
    $docRoot = __DIR__ . '/../public';
    echo "Starting development server at http://localhost:{$port}\n";
    echo "Document root: {$docRoot}\n";
    echo "Press Ctrl+C to stop.\n\n";
    passthru("php -S localhost:{$port} -t " . escapeshellarg($docRoot));
    exit(0);
}

if ($commandName === 'help') {
    echo "Available commands:\n";
    printf("  %-15s %s\n", 'serve [port]', 'Start development server (default: 8080)');
    foreach ($commands as $name => $cmd) {
        printf("  %-15s %s\n", $name, $cmd->getDescription());
    }
    echo "\n";
    exit(0);
}

if (isset($commands[$commandName])) {
    $commands[$commandName]->execute($commandArgs);
} else {
    echo "Unknown command: {$commandName}\n";
    echo "Run 'php bin/cerne help' to see available commands.\n";
    exit(1);
}

echo "\n";
